---
title: "RubyでGoogleドライブにファイルをアップロードする方法"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## やりたいこと

外部 API を叩いて生成した画像を一括で Google ドライブに入れる際に、Google API を使うとスクリプトを叩くことで実現することができます。
本記事では、Google ドライブに保存する際の事前準備とスクリプトのサンプルコードをまとめておきます。
なお、スクリプトは Ruby で実装しています。

## 環境

Ruby 3.1.3

また、Ruby で実装するにあたり Google が公式で出している下記の gem を使用しました。

- [google/apis/drive_v3](https://github.com/googleapis/google-api-ruby-client)
- [googleauth](https://github.com/googleapis/google-auth-library-ruby)

## 手順

1. Google コンソールで新規プロジェクトを作成する

2. 作成したプロジェクトで Google ドライブの API を有効化する

3. プロジェクト内で編集権限を持つサービスアカウントを作成する

4. 作成したサービスアカウントに紐つくキーを作成して json 形式でダウンロードして所定の箇所に配置する（今回はルート直下）

5. Google ドライブに保存用のフォルダを作成、フォルダ ID を控えておく

6. 作成したフォルダにファイルが登録できるようにサービスアカウントを共有する

7. Ruby コマンドを実行してスクリプトを実行する

```shell
$ ruby test.rb
```

9. 確認

### ソース

```ruby
require 'google/apis/drive_v3'
require 'googleauth'

authorizer = Google::Auth::ServiceAccountCredentials.make_creds(
  json_key_io: File.open('./client_secret.json'),
  scope: 'https://www.googleapis.com/auth/drive')
authorizer.fetch_access_token!
drive = Google::Apis::DriveV3::DriveService.new
drive.authorization = authorizer

# Upload a file
metadata = Google::Apis::DriveV3::File.new(name: 'sample.png', parents: ['GoogleドライブのフォルダID'])
drive.create_file(metadata, upload_source: './sample.png', content_type: 'image/png')
```

### メモ

共有フォルダの場合、`creae_file`の引数に`supports_team_drives: true`を追加する

```ruby
drive.create_file(metadata, upload_source: './sample.png', supports_team_drives: true, ontent_type: 'image/png')
```
